<html>
<head>
  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <title>Apples 2 Apples</title>
</head>
<body>
  <script type='text/javascript'>

    updateGame = function() {
      console.log('updateGame');
      $("#players").text(newState['numberOfPlayers']);
    };

    sendMessage = function(path, opt_param) {
      console.log('sendMessage');

      //path += '?g=' + state.game_key;
      if (opt_param) {
        path += '&' + opt_param;
      }
      var xhr = new XMLHttpRequest();
      xhr.open('POST', path, true);
      xhr.send();
    };
    
    onOpened = function() {
      console.log('onOpened');
      sendMessage('/opened');
    };
    
    onMessage = function(m) {
      console.log('onMessage');
      newState = JSON.parse(m.data);
      updateGame();
    }
    
    openChannel = function() {
      var token = '{{ token }}';
      var channel = new goog.appengine.Channel(token);
      var handler = {
        'onopen': onOpened,
        'onmessage': onMessage,
        'onerror': function() {},
        'onclose': function() {}
      };
      var socket = channel.open(handler);
      socket.onopen = onOpened;
      socket.onmessage = onMessage;
    }
    
    /*initialize = function() {
      openChannel();
      //onMessage({data: "MESSAGE"});
    }      

    setTimeout(initialize, 100);*/

    $(document).ready(function() {
      openChannel();

      $('#cards').delegate('input', 'click', function(e) {
        var card = $(this).attr("value");
        sendMessage('/play_card', 'c='+card);
      });
    });

  </script>



<div style="width:800px; margin: 0 auto;">
<h3>Number of Players: <span id="players"></span></h3>
<h1>{{ current_green_card }}</h1>

<h2>Score: {{ score }}</h2>
<div id="cards">
{% for card in cards %}
    <input type="button" value="{{ card }}" />
{% endfor %}
</div>

</div>

</body>
</html>
